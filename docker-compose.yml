# NewAPI Tools - Docker Compose Configuration
#
# 使用方式:
#   开发模式: make dev
#   生产部署: docker compose up -d
#
# 本地构建: docker compose build && docker compose up -d

services:
  # NewAPI Tools 主服务 (一体化架构: 后端 + 前端界面)
  newapi-tools:
    image: ghcr.io/james-6-23/new_api_tools:latest
    # 本地构建使用以下配置（注释掉 image 行）:
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    #   target: runtime
    container_name: newapi-tools
    ports:
      # 统一端口：前端界面 + API
      - '${PORT:-3000}:3000'
    volumes:
      # 数据目录持久化
      - ./data:/app/data
      # 可选：日志持久化
      - ./logs:/app/logs
    environment:
      # 服务器配置
      - SERVER_MODE=${SERVER_MODE:-release}
      - SERVER_PORT=3000
      # 数据库配置 (SQL_DSN 优先)
      - SQL_DSN=${SQL_DSN}
      - DATABASE_ENGINE=${DB_ENGINE:-postgres}
      - DATABASE_HOST=${DB_HOST:-postgres}
      - DATABASE_PORT=${DB_PORT:-5432}
      - DATABASE_NAME=${DB_NAME:-new-api}
      - DATABASE_USER=${DB_USER:-postgres}
      - DATABASE_PASSWORD=${DB_PASSWORD}
      - DATABASE_LOCAL_DB_PATH=/app/data/local.db
      # Redis 配置 (REDIS_CONN_STRING 优先)
      - REDIS_CONN_STRING=${REDIS_CONN_STRING:-redis://redis:6379}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=${REDIS_DB:-0}
      # 认证配置
      - AUTH_API_KEY=${API_KEY}
      - AUTH_ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - AUTH_JWT_SECRET=${JWT_SECRET}
      - AUTH_JWT_EXPIRE_HOURS=${JWT_EXPIRE_HOURS:-24}
      # GeoIP 配置
      - GEOIP_DB_PATH=/app/data/GeoLite2-Country.mmdb
      # 时区
      - TZ=Asia/Shanghai
    # 健康检查配置
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3000/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # 资源限制 (Go 应用内存占用更低)
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.25'
    # 重启策略
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    networks:
      - default
      - newapi-network

  # Redis 缓存服务
  redis:
    image: redis:7-alpine
    container_name: newapi-tools-redis
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - default
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  default:
  newapi-network:
    external: true
    name: ${NEWAPI_NETWORK:-new-api_default}

volumes:
  redis_data:
